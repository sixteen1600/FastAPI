<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†è€…å¾Œå°</title>
</head>
<body>
    <h1>ç®¡ç†è€…ä»‹é¢</h1>
    <p>æ­¡è¿ç®¡ç†è€…ï¼</p>
    <div id="user-list">
        <h3>ä½¿ç”¨è€…æ¸…å–®ï¼š</h3>
        <ul id="users"></ul>
    </div>

    <script type="module">
        // æ”¹ç‚ºå¼•å…¥å…±ç”¨æ¨¡çµ„
        import { auth } from "/static/js/firebaseConfig.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        async function checkAdminAndLoadUsers(user) {
            try {
                const idToken = await user.getIdToken();

                // é©—è­‰æ˜¯å¦ç‚º admin
                const whoamiRes = await fetch("http://localhost:8000/whoami", {
                    headers: {
                        Authorization: `Bearer ${idToken}`
                    }
                });

                if (!whoamiRes.ok) {
                    throw new Error("ç„¡æ³•ç¢ºèªèº«ä»½");
                }

                const whoamiData = await whoamiRes.json();
                if (whoamiData.role !== "admin") {
                    alert("æ‚¨ä¸æ˜¯ç®¡ç†è€…ï¼Œç„¡æ³•é€²å…¥è©²é é¢");
                    window.location.href = "/";
                    return;
                }

                // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…
                const response = await fetch("http://localhost:8000/allUsers", {
                    headers: {
                        Authorization: `Bearer ${idToken}`
                    }
                });

                if (!response.ok) {
                    const err = await response.json();
                    alert("æ¬Šé™éŒ¯èª¤ï¼š" + err.detail);
                    return;
                }

                const users = await response.json();
                const list = document.getElementById("users");
                users.forEach(u => {
                    const item = document.createElement("li");
                    item.textContent = `${u.id} - ${u.name} (${u.email})`;
                    list.appendChild(item);
                });

            } catch (err) {
                console.error("ğŸš¨ éŒ¯èª¤ç™¼ç”Ÿï¼š", err);
                alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                window.location.href = "/";
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                checkAdminAndLoadUsers(user);
            } else {
                alert("è«‹å…ˆç™»å…¥");
                window.location.href = "/";
            }
        });
    </script>
</body>
</html>
